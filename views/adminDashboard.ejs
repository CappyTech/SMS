<!-- views/adminDashboard.ejs -->
<h1>Admin Dashboard</h1>
<small>[Users: <%= userCount %> | Subcontractors: <%= subcontractorCount %> | Invoices: <%= invoiceCount %> ]</small>

<!-- Display error messages -->
<% if (errorMessages.length > 0) { %>
<br>
<div class="alert alert-danger alert-dismissible fade show p-3" role="alert">
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    <% errorMessages.forEach(errorMessage => { %>
    <div><%= errorMessage %></div>
    <% }) %>
</div>
<% } %>

<!-- Display success message -->
<% if (successMessage.length > 0) { %>
<br>
<div class="alert alert-success alert-dismissible fade show p-3" role="alert">
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    <%= successMessage %>
</div>
<% } %>

<!-- Users table -->
<h2 class="text-center">Users</h2>
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
            </tr>
        </thead>
        <tbody>
            <% users.forEach(user => { %>
            <tr>
                <td><a href="/admin/user/edit/<%= user.id %>"><%= user.username %></a></td>
                <td><%= user.email %></td>
                <td><%= user.role %></td>
            </tr>
            <% }); %>
        </tbody>
    </table>
</div>

<!-- Subcontractors table -->
<h2 class="text-center">Subcontractors</h2>
<% subcontractors.forEach(subcontractor => { %>
<h2><a href="/admin/subcontractor/edit/<%= subcontractor.id %>"><%= subcontractor.name %></a></h2>
<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>Invoice Number</th>
            <th>Kashflow Number</th>
            <th>Invoice Date</th>
            <th>Remittance Date</th>
            <th>Labour Cost</th>
            <th>Material Cost</th>
            <th>CIS Deduction</th>
            <th>Gross Amount</th>
            <th>Net Amount</th>
            <% if (subcontractor.isGross) { %>
            <th>Reverse Charge</th>
            <% } %>
            <th>Submission Date</th>
        </tr>
    </thead>
    <tbody>
        <!-- Invoices for the current subcontractor -->
        <% const subcontractorInvoices = invoices.filter(invoice => invoice.subcontractorId === subcontractor.id); %>
        <% subcontractorInvoices.forEach(invoice => { %>
        <tr>
            <td><a href="/admin/invoice/edit/<%= invoice.id %>"><%= invoice.invoiceNumber %></a></td>
            <td><a
                    href="https://app.kashflow.com/#purchases/<%= invoice.kashflowNumber %>"><%= invoice.kashflowNumber %></a>
            </td>
            <td><%= slimDateTime(invoice.invoiceDate) %></td>
            <td><%= slimDateTime(invoice.remittanceDate) %></td>
            <td><%= formatCurrency(invoice.labourCost) %></td>
            <td><%= formatCurrency(invoice.materialCost) %></td>
            <td><%= formatCurrency(invoice.cisAmount) %></td>
            <td><%= formatCurrency(invoice.grossAmount) %></td>
            <td><%= formatCurrency(invoice.netAmount) %></td>
            <% if (subcontractor.isGross) { %>
            <td><%= formatCurrency(invoice.reverseCharge) %></td>
            <% } %>
            <td><%= slimDateTime(invoice.submissionDate) %></td>
        </tr>
        <% }); %>
    </tbody>
</table>
<% }); %>