<div class="card d-print-none">
    <div class="card-header d-print-none">
        <button class="btn btn-hcs-green" data-bs-toggle="modal" data-bs-target="#pdfModal">Download as PDF</button>
    </div>
</div>
<div class="page-number">
    <%= supplier.Name %> | Heron Constructive Solutions LTD | <%= year %>-<%= (parseInt(year) + 1).toString().slice(-2) %> CIS Returns
</div>
<div class="mt-4">
    <h1 class="mb-4 display-3 text-center">
        <%= year %>-<%= (parseInt(year) + 1).toString().slice(-2) %> Returns
    </h1>
    <div class="row justify-content-evenly">
        <div class="col-6 ms-auto text-center">
            <p class="display-5">Subcontractor</p>
            <p>
                <%= supplier.Name %>
                <br>
                <%= [supplier.Address1, supplier.Address2, supplier.Address3, supplier.Address4, supplier.PostCode].filter(Boolean).join(', ') %>
            </p>
        </div>
        <div class="col-6 text-center">
            <p class="display-5">Contractor</p>
            <p>
                Heron Constructive Solutions LTD
                <br>
                103 Herondale Road,
                Mossley Hill,
                Liverpool,
                Merseyside,
                L18 1JZ.
            </p>
        </div>
    </div>
</div>

<% for (let monthIndex = 1; monthIndex <= 12; monthIndex++) { %>
    <% const monthKey = monthIndex.toString(); %>
    <% let receipts = receiptsByMonth[monthKey] || []; %>
    <% receipts = receipts.sort((a, b) => new Date(a.PayDate) - new Date(b.PayDate)); %>
    <% const hasReceipts = receipts.length > 0; %>
    <% if (hasReceipts) { %>
        <% if (pageBreakMonths.includes(monthIndex)) { %>
            <table class="table table-hover table-sm caption-top page-break d-print-table">
        <% } else { %>
            <table class="table table-hover table-sm caption-top d-print-table">
        <% } %>
        <caption class="text-center">Month <%= monthKey %> (<%= monthNames[monthIndex - 1] %> <%= year %>)</caption>
            <thead>
                <tr>
                    <th>
                        <span class="d-none d-md-table-cell">Invoice</span>
                        <span class="d-md-none">Inv</span>
                    </th>
                    <th>
                        <span class="d-none d-md-table-cell">Kashflow</span>
                        <span class="d-md-none">KF</span>
                    </th>
                    <th>
                        <span class="d-none d-md-table-cell">Invoiced</span>
                        <span class="d-md-none">Invoiced</span>
                    </th>
                    <th>
                        <span class="d-none d-md-table-cell">Paid</span>
                        <span class="d-md-none">Paid</span>
                    </th>
                    <th>
                        <span class="d-none d-md-table-cell">Gross</span>
                        <span class="d-md-none">Gross</span>
                    </th>
                    <th>
                        <span class="d-none d-md-table-cell">Labour</span>
                        <span class="d-md-none">Labour</span>
                    </th>
                    <th>
                        <span class="d-none d-md-table-cell">Material</span>
                        <span class="d-md-none">Material</span>
                    </th>
                    <th>
                        <span class="d-none d-md-table-cell">
                            CIS @ 
                            <% if (supplier.CISRate==='0') { %>
                                0%
                            <% } else if (supplier.CISRate==='0.2') { %>
                                20%
                            <% } else if (supplier.CISRate==='0.3') { %>
                                30%
                            <% } %>
                        </span>
                        <span class="d-md-none">CIS</span>
                    </th>
                    <th>
                        <span class="d-none d-md-table-cell">Net</span>
                        <span class="d-md-none">Net</span>
                    </th>
                    <% if (supplier.isReverseCharge) { %>
                    <th>
                        <span class="d-none d-md-table-cell">Reverse Charge</span>
                        <span class="d-md-none">RC</span>
                    </th>
                    <% } %>
                    <th>
                        <span class="d-none d-md-table-cell">Submission Date</span>
                        <span class="d-md-none">Submission</span>
                    </th>
                </tr>
            </thead>
            <tbody>
                <% let totalGross = 0, totalLabour = 0, totalMaterial = 0, totalCIS = 0, totalNet = 0; %>
                <% receipts.forEach(receipt => { %>
                    <tr>
                        <td><%= receipt.InvoiceNumber %></td>
                        <td><%= receipt.KashflowNumber %></td>
                        <td><%= slimDateTime(receipt.InvoiceDate) %></td>
                        <td><%= receipt.PayDate %></td>
                        <td><%= formatCurrency(receipt.GrossAmount) %></td>
                        <td><%= formatCurrency(receipt.LabourCost) %></td>
                        <td><%= formatCurrency(receipt.MaterialCost) %></td>
                        <td><%= formatCurrency(receipt.CISAmount) %></td>
                        <td><%= formatCurrency(receipt.NetAmount) %></td>
                        <td><%= slimDateTime(receipt.SubmissionDate) %></td>
                    </tr>
                    <% totalGross += receipt.GrossAmount; %>
                    <% totalLabour += receipt.LabourCost; %>
                    <% totalMaterial += receipt.MaterialCost; %>
                    <% totalCIS += receipt.CISAmount; %>
                    <% totalNet += receipt.NetAmount; %>
                <% }) %>
                <tr class="fw-bold">
                    <td colspan="4">Total for Month <%= monthKey %>:</td>
                    <td><%= formatCurrency(totalGross) %></td>
                    <td><%= formatCurrency(totalLabour) %></td>
                    <td><%= formatCurrency(totalMaterial) %></td>
                    <td><%= formatCurrency(totalCIS) %></td>
                    <td><%= formatCurrency(totalNet) %></td>
                    <td></td>
                </tr>
            </tbody>
        </table>
    <% } %>
<% } %>


  <!-- PDF Options Modal -->
  <div class="modal fade" id="pdfModal" tabindex="-1" aria-labelledby="pdfModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <form action="/kashflow/yearly/download-pdf" method="POST">
        <input type="hidden" name="year" value="<%= year %>">
        <input type="hidden" name="uuid" value="<%= supplier.uuid %>">
        <input type="hidden" name="pageBreakMonths" value="<%= pageBreakMonths.join(',') %>">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">PDF Options</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body row g-3">

            <div class="col-md-12">
                <label class="form-label">Filename</label>
                <input type="text" name="filename" class="form-control" placeholder="<%= supplier.Name %> | Heron Constructive Solutions LTD | <%= year %>-<%= (parseInt(year) + 1).toString().slice(-2) %> CIS Returns" value="<%= supplier.Name %> | Heron Constructive Solutions LTD | <%= year %>-<%= (parseInt(year) + 1).toString().slice(-2) %> CIS Returns" required>
            </div>

            <div class="col-md-4">
              <label class="form-label">Format</label>
              <select name="format" class="form-select">
                <option>A4</option>
                <option>Letter</option>
                <option>A3</option>
                <option>A5</option>
                <option>Legal</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Width (if custom)</label>
              <input type="text" class="form-control" name="width" placeholder="e.g., 8.5in">
            </div>

            <div class="col-md-4">
              <label class="form-label">Height (if custom)</label>
              <input type="text" class="form-control" name="height" placeholder="e.g., 11in">
            </div>

            <div class="col-md-4">
              <label class="form-label">Orientation</label>
              <select name="landscape" class="form-select">
                <option value="0">Portrait</option>
                <option value="1">Landscape</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Scale (0.1 - 2.0)</label>
              <input type="number" step="0.1" min="0.1" max="2.0" name="scale" class="form-control" value="1">
            </div>

            <div class="col-md-4">
              <label class="form-label">Page Ranges</label>
              <input type="text" name="pageRanges" class="form-control" placeholder="e.g., 1-3,5">
            </div>

            <div class="col-md-4">
              <label class="form-label">Top Margin</label>
              <input type="text" name="marginTop" class="form-control" value="20mm">
            </div>
            <div class="col-md-4">
              <label class="form-label">Bottom Margin</label>
              <input type="text" name="marginBottom" class="form-control" value="20mm">
            </div>
            <div class="col-md-4">
              <label class="form-label">Left Margin</label>
              <input type="text" name="marginLeft" class="form-control" value="15mm">
            </div>
            <div class="col-md-4">
              <label class="form-label">Right Margin</label>
              <input type="text" name="marginRight" class="form-control" value="15mm">
            </div>

            <div class="col-md-4 form-check mt-3">
              <input class="form-check-input" type="checkbox" name="printBackground" id="printBackground">
              <label class="form-check-label" for="printBackground">Print Background</label>
            </div>

            <div class="col-md-4 form-check mt-3">
              <input class="form-check-input" type="checkbox" name="preferCSSPageSize" id="preferCSSPageSize">
              <label class="form-check-label" for="preferCSSPageSize">Prefer CSS Page Size</label>
            </div>

            <div class="col-md-4 form-check mt-3">
              <input class="form-check-input" type="checkbox" name="displayHeaderFooter" id="displayHeaderFooter">
              <label class="form-check-label" for="displayHeaderFooter">Display Header/Footer</label>
            </div>

            <div class="col-12 mt-3">
              <label class="form-label">Header HTML</label>
              <textarea class="form-control" name="headerTemplate" rows="2" placeholder="Optional: custom HTML for header..."></textarea>
            </div>

            <div class="col-12">
              <label class="form-label">Footer HTML</label>
              <textarea class="form-control" name="footerTemplate" rows="2" placeholder="Optional: custom HTML for footer..."></textarea>
            </div>

          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-hcs-green">Generate PDF</button>
          </div>
        </div>
      </form>
    </div>
  </div>